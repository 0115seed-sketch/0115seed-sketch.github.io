<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ê°í˜• ê²Œì„ - êµì‚¬ìš©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        .card { transition: all 0.3s ease; }
        .buzzer-item { transition: all 0.3s ease; transform: scale(1); }
        .buzzer-item.first-place { background-color: #fef08a; transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- ìŠ¤í¬ë¦° 1: ì„¸ì…˜ ìƒì„± -->
        <div id="create-session-screen" class="screen active text-center bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-bold mb-4">ì‚¬ê°í˜• ì„±ì§ˆ ì‹¤ì‹œê°„ ìˆ˜ì—…</h1>
            <p class="text-lg text-gray-600 mb-8">ìˆ˜ì—…ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            <button id="create-session-btn" class="bg-indigo-600 text-white font-bold py-4 px-8 rounded-xl text-2xl hover:bg-indigo-700 transition-transform transform hover:scale-105">
                ìˆ˜ì—… ë§Œë“¤ê¸°
            </button>
        </div>

        <!-- ìŠ¤í¬ë¦° 2: ëŒ€ê¸° ë° ê²Œì„ í™”ë©´ -->
        <div id="game-screen" class="screen">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- ì™¼ìª½: ê²Œì„ ì»¨íŠ¸ë¡¤ ë° ì¹´ë“œ í‘œì‹œ -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                    <!-- í—¤ë”: ìˆ˜ì—… ID -->
                    <div class="text-center mb-4 border-b pb-4">
                        <h2 class="text-xl font-semibold text-gray-500">ìˆ˜ì—… ID (í•™ìƒë“¤ì—ê²Œ ì•Œë ¤ì£¼ì„¸ìš”)</h2>
                        <p id="session-id-display" class="text-4xl font-bold text-indigo-600 tracking-widest bg-gray-100 p-2 rounded-lg select-all">....</p>
                    </div>

                    <!-- ì¹´ë“œ ì„¤ì • -->
                    <div id="settings-view" class="flex justify-center items-center gap-8 my-6">
                        <div>
                            <label for="card-count" class="block text-lg font-medium text-gray-700 mb-2">ì¹´ë“œ ìˆ˜</label>
                            <input type="number" id="card-count" value="3" min="2" max="5" class="w-full p-3 text-center text-lg border-2 border-gray-300 rounded-lg">
                        </div>
                        <button id="start-round-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-xl text-xl self-end hover:bg-green-600 transition">ë¼ìš´ë“œ ì‹œì‘</button>
                    </div>

                    <!-- ì¹´ë“œ í‘œì‹œ ì»¨í…Œì´ë„ˆ -->
                    <div id="card-view" class="hidden">
                        <div id="card-container" class="flex flex-wrap justify-center items-center gap-4 min-h-[140px] mb-4 bg-gray-50 p-4 rounded-lg">
                            <!-- JSë¡œ ì¹´ë“œ ìƒì„± -->
                        </div>
                         <p id="answer-display" class="text-center text-2xl font-bold min-h-[40px]"></p>
                    </div>

                    <!-- ê²Œì„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
                    <div class="mt-6 flex justify-center gap-4">
                        <button id="check-answer-btn" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-blue-600 transition hidden">ì •ë‹µ í™•ì¸</button>
                        <button id="next-round-btn" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-gray-600 transition hidden">ë‹¤ìŒ ë¬¸ì œ</button>
                        <button id="reset-game-btn" class="bg-yellow-500 text-gray-800 font-bold py-3 px-6 rounded-lg text-lg hover:bg-yellow-600 transition">ì²˜ìŒìœ¼ë¡œ</button>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ì ‘ì† í˜„í™© ë° ìŠ¤ì½”ì–´ë³´ë“œ -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center border-b pb-3 mb-4">ì‹¤ì‹œê°„ í˜„í™©íŒ</h3>
                    <!-- ë²„ì € ìˆœìœ„ -->
                    <div id="buzzer-list-container" class="mb-4">
                        <h4 class="font-semibold text-lg mb-2">ğŸ ì¢… ëˆ„ë¥¸ ìˆœì„œ</h4>
                        <ul id="buzzer-list" class="space-y-2 min-h-[100px] bg-gray-50 p-3 rounded-lg">
                            <li class="text-gray-400">ëŒ€ê¸° ì¤‘...</li>
                        </ul>
                    </div>
                    <!-- ì ìˆ˜íŒ -->
                    <div>
                        <h4 class="font-semibold text-lg mb-2">ğŸ† ì ìˆ˜íŒ</h4>
                        <ul id="scoreboard" class="space-y-2 min-h-[200px] bg-gray-50 p-3 rounded-lg">
                             <li class="text-gray-400">ì°¸ê°€íŒ€ ì—†ìŒ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ íƒ€ì… 'module'ë¡œ ë³€ê²½ -->
    <script type="module">
        // --- Firebase ì„¤ì • ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaEEBdKzMONv9f8YgTWLK4s2PJFjTM31Q",
            authDomain: "card-game-class.firebaseapp.com",
            projectId: "card-game-class",
            storageBucket: "card-game-class.appspot.com",
            messagingSenderId: "620033523838",
            appId: "1:620033523838:web:6e37f0e6b4d0bab7b1d82f",
            measurementId: "G-F9JV9Z17QF"
        };
        // -------------------------------------------------

        // Firebase v9(ëª¨ë“ˆì‹) SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, increment, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ë°ì´í„° ì •ì˜ ---
        const CARDS = [
            { id: 's1', name: 'ì‚¬ë‹¤ë¦¬ê¼´', type: 'shape' }, { id: 's2', name: 'í‰í–‰ì‚¬ë³€í˜•', type: 'shape' },
            { id: 's3', name: 'ë§ˆë¦„ëª¨', type: 'shape' }, { id: 's4', name: 'ì§ì‚¬ê°í˜•', type: 'shape' },
            { id: 's5', name: 'ì •ì‚¬ê°í˜•', type: 'shape' }, { id: 'p1', name: 'ë‘ ëŒ€ê°ì„ ì˜ ê¸¸ì´ê°€ ê°™ë‹¤.', type: 'property' },
            { id: 'p2', name: 'ë‘ ëŒ€ê°ì„ ì´ ì„œë¡œ ìˆ˜ì§ì´ë‹¤.', type: 'property' }, { id: 'p3', name: 'ë‘ ëŒ€ê°ì„ ì´ ì„œë¡œë¥¼ ì´ë“±ë¶„í•œë‹¤.', type: 'property' },
        ];
        const RELATIONSHIPS = {
            's1': [], 's2': ['p3'], 's3': ['p2', 'p3'], 's4': ['p1', 'p3'], 's5': ['p1', 'p2', 'p3'],
        };

        // --- ì˜¤ë””ì˜¤ ê°ì²´ ---
        const bellSound = new Audio('bell.mp3');

        // --- DOM ìš”ì†Œ ---
        const createSessionScreen = document.getElementById('create-session-screen');
        const gameScreen = document.getElementById('game-screen');
        const createSessionBtn = document.getElementById('create-session-btn');
        const sessionIdDisplay = document.getElementById('session-id-display');
        const scoreboard = document.getElementById('scoreboard');
        const buzzerList = document.getElementById('buzzer-list');
        const startRoundBtn = document.getElementById('start-round-btn');
        const cardCountInput = document.getElementById('card-count');
        const cardContainer = document.getElementById('card-container');
        const cardView = document.getElementById('card-view');
        const settingsView = document.getElementById('settings-view');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const answerDisplay = document.getElementById('answer-display');

        // --- ê²Œì„ ìƒíƒœ ë³€ìˆ˜ ---
        let currentSessionId = null;
        let sessionUnsubscribe = null;
        let currentCards = [];

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        createSessionBtn.addEventListener('click', createSession);
        startRoundBtn.addEventListener('click', startRound);
        checkAnswerBtn.addEventListener('click', showAnswer);
        nextRoundBtn.addEventListener('click', startRound);
        resetGameBtn.addEventListener('click', resetGame);
        
        scoreboard.addEventListener('click', e => {
            const target = e.target;
            if (target.matches('.score-plus')) {
                const teamName = target.dataset.teamname;
                adjustScore(teamName, 10);
            } else if (target.matches('.score-minus')) {
                const teamName = target.dataset.teamname;
                adjustScore(teamName, -10);
            }
        });

        // --- í•¨ìˆ˜ ---
        async function adjustScore(teamName, amount) {
            const sessionRef = doc(db, 'sessions', currentSessionId);
            const updatePath = `teams.${teamName}.score`;
            await updateDoc(sessionRef, {
                [updatePath]: increment(amount)
            });
        }

        async function createSession() {
            currentSessionId = Math.floor(1000 + Math.random() * 9000).toString();
            const sessionRef = doc(db, 'sessions', currentSessionId);
            await setDoc(sessionRef, {
                createdAt: serverTimestamp(),
                gameState: 'waiting',
                teams: {},
                buzzerOrder: [],
                currentCards: []
            });
            sessionIdDisplay.textContent = currentSessionId;
            createSessionScreen.classList.remove('active');
            gameScreen.classList.add('active');
            listenToSession();
        }

        function listenToSession() {
            if (sessionUnsubscribe) sessionUnsubscribe();
            const sessionRef = doc(db, 'sessions', currentSessionId);
            sessionUnsubscribe = onSnapshot(sessionRef, (doc) => {
                const data = doc.data();
                if (!data) return;
                updateScoreboard(data.teams);
                updateBuzzerList(data.buzzerOrder);
            });
        }

        function updateScoreboard(teams) {
            scoreboard.innerHTML = '';
            const sortedTeams = Object.entries(teams).sort(([, a], [, b]) => b.score - a.score);
            if (sortedTeams.length === 0) {
                 scoreboard.innerHTML = '<li class="text-gray-400">ì°¸ê°€íŒ€ ì—†ìŒ</li>';
                 return;
            }
            sortedTeams.forEach(([teamName, teamData]) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-white rounded-lg';
                li.innerHTML = `
                    <span class="font-medium">${teamName}</span>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-lg text-indigo-600">${teamData.score}ì </span>
                        <button data-teamname="${teamName}" class="score-plus bg-green-500 text-white w-7 h-7 rounded-full font-bold text-lg leading-none hover:bg-green-600">+</button>
                        <button data-teamname="${teamName}" class="score-minus bg-red-500 text-white w-7 h-7 rounded-full font-bold text-lg leading-none hover:bg-red-600">-</button>
                    </div>
                `;
                scoreboard.appendChild(li);
            });
        }

        let lastBuzzerLength = 0;
        function updateBuzzerList(buzzerOrder) {
            buzzerList.innerHTML = '';
             if (buzzerOrder.length > lastBuzzerLength) {
                bellSound.play();
            }
            lastBuzzerLength = buzzerOrder.length;
            
            if (buzzerOrder.length === 0) {
                buzzerList.innerHTML = '<li class="text-gray-400">ëŒ€ê¸° ì¤‘...</li>';
                return;
            }
            
            buzzerOrder.forEach((buzzer, index) => {
                const li = document.createElement('li');
                li.className = 'buzzer-item flex items-center p-2 bg-white rounded-lg';
                if (index === 0) {
                    li.classList.add('first-place');
                    li.innerHTML = `<span class="text-2xl mr-2">ğŸ¥‡</span> <span class="font-bold text-lg">${buzzer.teamName}</span>`;
                } else {
                    li.innerHTML = `<span class="font-semibold mr-2">${index + 1}.</span> <span class="font-medium">${buzzer.teamName}</span>`;
                }
                buzzerList.appendChild(li);
            });
        }

        async function startRound() {
            settingsView.style.display = 'none';
            cardView.classList.remove('hidden');
            nextRoundBtn.classList.remove('hidden');
            checkAnswerBtn.classList.remove('hidden');
            checkAnswerBtn.disabled = false;
            startRoundBtn.disabled = true;
            answerDisplay.textContent = ''; // ì´ì „ ì •ë‹µ ì§€ìš°ê¸°

            const cardCount = parseInt(cardCountInput.value);
            currentCards = [];
            for (let i = 0; i < cardCount; i++) {
                currentCards.push(CARDS[Math.floor(Math.random() * CARDS.length)]);
            }
            
            cardContainer.innerHTML = '';
            currentCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card bg-gray-200 border-2 rounded-xl p-4 flex items-center justify-center text-center font-medium h-28 w-32 shadow-md';
                cardEl.textContent = card.name;
                cardContainer.appendChild(cardEl);
            });
            
            const sessionRef = doc(db, 'sessions', currentSessionId);
            await updateDoc(sessionRef, {
                gameState: 'question',
                currentCards: currentCards,
                buzzerOrder: []
            });
            lastBuzzerLength = 0;
        }

        function checkAnswer() {
            const shapes = currentCards.filter(c => c.type === 'shape');
            const properties = currentCards.filter(c => c.type === 'property');
            if (!shapes.length || !properties.length) return false;
            for (const shape of shapes) {
                for (const prop of properties) {
                    if (RELATIONSHIPS[shape.id].includes(prop.id)) return true;
                }
            }
            return false;
        }

        function showAnswer() {
            const isGameCorrect = checkAnswer();
            answerDisplay.textContent = isGameCorrect ? "O ì •ë‹µì…ë‹ˆë‹¤" : "X ì˜¤ë‹µì…ë‹ˆë‹¤";
            answerDisplay.style.color = isGameCorrect ? 'blue' : 'red';
            checkAnswerBtn.disabled = true;
        }
        
        async function resetForNextRound() {
            settingsView.style.display = 'flex';
            cardView.classList.add('hidden');
            nextRoundBtn.classList.add('hidden');
            checkAnswerBtn.classList.add('hidden');
            startRoundBtn.disabled = false;
            answerDisplay.textContent = '';
            
            const sessionRef = doc(db, 'sessions', currentSessionId);
            await updateDoc(sessionRef, {
                gameState: 'waiting',
                buzzerOrder: []
            });
            lastBuzzerLength = 0;
        }

        async function resetGame() {
            if (!confirm('ì •ë§ ê²Œì„ì„ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì ìˆ˜ë„ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;
            
            const sessionRef = doc(db, 'sessions', currentSessionId);
            await updateDoc(sessionRef, {
                teams: {},
                buzzerOrder: [],
                gameState: 'waiting'
            });

            // resetForNextRound()ëŠ” ì´ì œ 'ì²˜ìŒìœ¼ë¡œ'ì—ì„œë§Œ ì‚¬ìš©ë¨
            settingsView.style.display = 'flex';
            cardView.classList.add('hidden');
            nextRoundBtn.classList.add('hidden');
            checkAnswerBtn.classList.add('hidden');
            startRoundBtn.disabled = false;
            answerDisplay.textContent = '';
        }
    </script>
</body>
</html>

