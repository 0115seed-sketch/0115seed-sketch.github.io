<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ===================== 문제 해결 부분 ===================== -->
    <!-- 모바일 브라우저 캐시 방지용 메타 태그 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- ======================================================== -->

    <title>교실 발표벨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .buzzer-btn.active {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .toast-message {
            padding: 12px 24px;
            background-color: #ef4444;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-weight: 500;
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto p-4">

        <div id="role-selection" class="text-center bg-white p-8 rounded-xl shadow-lg fade-in">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">발표벨에 오신 것을<br>환영합니다!</h1>
            <p class="text-gray-600 mb-8">역할을 선택해주세요.</p>
            <div class="space-y-4">
                <button onclick="showTeacherLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">선생님</button>
                <button onclick="showStudentLogin()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">학생</button>
            </div>
        </div>

        <div id="teacher-login" class="hidden text-center bg-white p-8 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">교사 인증</h2>
            <input type="password" id="password" placeholder="비밀번호를 입력하세요" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="login()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 mb-2">로그인</button>
            <button onclick="showRoleSelection()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">뒤로가기</button>
        </div>

        <div id="student-login" class="hidden text-center bg-white p-8 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">닉네임 입력</h2>
            <input type="text" id="nickname" placeholder="닉네임을 입력하세요" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-green-500">
            <button onclick="joinAsStudent()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 mb-2">참여하기</button>
            <button onclick="showRoleSelection()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">뒤로가기</button>
        </div>

        <div id="teacher-page" class="hidden bg-white p-8 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">교사 페이지</h2>
            <div class="flex space-x-2 mb-4">
                <button id="start-btn" onclick="startSession()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">발표 시작</button>
                <button id="stop-btn" onclick="stopSession()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">발표 중지</button>
                <button onclick="resetSession()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">초기화</button>
            </div>
            <p id="teacher-status" class="text-center text-gray-600 mb-4 font-semibold">대기 중...</p>
            <div class="bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto border">
                <h3 class="font-bold mb-2">발표 순서</h3>
                <ul id="buzzer-list" class="list-decimal list-inside space-y-2 text-gray-700">
                </ul>
            </div>
             <button onclick="showRoleSelection()" class="mt-4 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">나가기</button>
        </div>

        <div id="student-page" class="hidden text-center bg-white p-8 rounded-xl shadow-lg fade-in">
            <h2 id="student-welcome" class="text-2xl font-bold text-gray-800 mb-4"></h2>
            <p id="student-status" class="text-gray-600 mb-8 font-semibold">선생님이 발표를 시작하기를 기다리는 중...</p>
            <button id="buzzer-btn" onclick="buzzIn()" disabled class="buzzer-btn w-48 h-48 bg-gray-400 text-white font-bold text-3xl rounded-full transition duration-300 focus:outline-none disabled:cursor-not-allowed disabled:opacity-50">
                벨
            </button>
             <button onclick="showRoleSelection()" class="mt-8 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">나가기</button>
        </div>
    </div>

    <div id="message-container" class="fixed bottom-5 right-5 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcszBKZTxlQL54TwcjNIapAfp4tLpuTS0",
            authDomain: "raise-your-hand-d34fb.firebaseapp.com",
            projectId: "raise-your-hand-d34fb",
            storageBucket: "raise-your-hand-d34fb.appspot.com",
            messagingSenderId: "725866951830",
            appId: "1:725866951830:web:106df624f44033f07a3eb7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const sessionRef = doc(db, "presentationBell", "session");

        let userNickname = null;
        let hasBuzzed = false;
        const TEACHER_PASSWORD = "5873"; 

        const views = {
            roleSelection: document.getElementById('role-selection'),
            teacherLogin: document.getElementById('teacher-login'),
            studentLogin: document.getElementById('student-login'),
            teacherPage: document.getElementById('teacher-page'),
            studentPage: document.getElementById('student-page'),
        };

        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
        }

        function showMessage(text) {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.textContent = text;
            messageDiv.className = 'toast-message';
            container.appendChild(messageDiv);

            setTimeout(() => { messageDiv.classList.add('show'); }, 10);
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => { container.removeChild(messageDiv); }, 300);
            }, 3000);
        }
        
        window.showRoleSelection = () => {
            userNickname = null;
            hasBuzzed = false;
            document.getElementById('password').value = '';
            document.getElementById('nickname').value = '';
            showView('roleSelection');
        };

        window.showTeacherLogin = () => showView('teacherLogin');
        window.showStudentLogin = () => showView('studentLogin');

        window.login = () => {
            const password = document.getElementById('password').value;
            if (password === TEACHER_PASSWORD) {
                showView('teacherPage');
                listenForSessionChangesTeacher();
            } else {
                showMessage('비밀번호가 틀렸습니다.');
            }
        };

        window.joinAsStudent = () => {
            const nickname = document.getElementById('nickname').value.trim();
            if (nickname) {
                userNickname = nickname;
                document.getElementById('student-welcome').innerText = `${userNickname}님, 환영합니다!`;
                showView('studentPage');
                listenForSessionChangesStudent();
            } else {
                showMessage('닉네임을 입력해주세요.');
            }
        };

        function listenForSessionChangesTeacher() {
            onSnapshot(sessionRef, (doc) => {
                const teacherStatus = document.getElementById('teacher-status');
                const buzzerList = document.getElementById('buzzer-list');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');

                if (!doc.exists()) {
                    resetSession();
                    return;
                }
                
                const data = doc.data();
                
                if (data.isActive) {
                    teacherStatus.innerText = "발표 진행 중...";
                    teacherStatus.className = "text-center text-green-600 mb-4 font-semibold";
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    teacherStatus.innerText = "대기 중...";
                    teacherStatus.className = "text-center text-gray-600 mb-4 font-semibold";
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }

                buzzerList.innerHTML = '';
                if (data.buzzers && Object.keys(data.buzzers).length > 0) {
                    const buzzersArray = Object.entries(data.buzzers).map(([nickname, timestamp]) => ({
                        nickname,
                        timestamp
                    }));
                    
                    const sortedBuzzers = buzzersArray.sort((a, b) => {
                        const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                        const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                        return timeA - timeB;
                    });
                    
                    sortedBuzzers.forEach(buzzer => {
                        if (buzzer && buzzer.nickname) {
                            const li = document.createElement('li');
                            li.textContent = buzzer.nickname;
                            buzzerList.appendChild(li);
                        }
                    });
                } else {
                    buzzerList.innerHTML = '<li class="text-gray-400">아직 벨을 누른 학생이 없습니다.</li>';
                }
            });
        }

        function listenForSessionChangesStudent() {
            onSnapshot(sessionRef, (doc) => {
                const studentStatus = document.getElementById('student-status');
                const buzzerBtn = document.getElementById('buzzer-btn');

                if (!doc.exists()) return;

                const data = doc.data();
                hasBuzzed = data.buzzers && data.buzzers[userNickname] !== undefined;

                if (data.isActive) {
                    if (hasBuzzed) {
                        studentStatus.innerText = "벨을 눌렀습니다! 다른 친구들을 기다려주세요.";
                        buzzerBtn.disabled = true;
                        buzzerBtn.classList.remove('active', 'bg-red-500', 'hover:bg-red-600');
                        buzzerBtn.classList.add('bg-gray-400');
                    } else {
                        studentStatus.innerText = "발표할 기회입니다! 벨을 누르세요.";
                        buzzerBtn.disabled = false;
                        buzzerBtn.classList.add('active', 'bg-red-500', 'hover:bg-red-600');
                        buzzerBtn.classList.remove('bg-gray-400');
                    }
                } else {
                    studentStatus.innerText = "선생님이 발표를 시작하기를 기다리는 중...";
                    buzzerBtn.disabled = true;
                    buzzerBtn.classList.remove('active', 'bg-red-500', 'hover:bg-red-600');
                    buzzerBtn.classList.add('bg-gray-400');
                }
            });
        }

        window.startSession = async () => {
            await updateDoc(sessionRef, { isActive: true });
        };
        
        window.stopSession = async () => {
            await updateDoc(sessionRef, { isActive: false });
        };

        window.resetSession = async () => {
            await setDoc(sessionRef, {
                isActive: false,
                buzzers: {}
            });
        };

        window.buzzIn = async () => {
            if (!userNickname || hasBuzzed) return;
            
            hasBuzzed = true;
            document.getElementById('buzzer-btn').disabled = true;

            const updatePayload = {};
            updatePayload[`buzzers.${userNickname}`] = serverTimestamp();
            await updateDoc(sessionRef, updatePayload);
        };

        showRoleSelection();
    </script>
</body>
</html>
