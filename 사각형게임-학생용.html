<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ê°í˜• ê²Œì„ - í•™ìƒìš©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .screen { display: none; }
        .screen.active { display: flex; }
        #buzzer-btn { transition: all 0.2s ease; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto p-4">
        <!-- ìŠ¤í¬ë¦° 1: ì ‘ì† -->
        <div id="join-screen" class="screen active flex-col items-center bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold mb-6">ìˆ˜ì—… ì°¸ì—¬í•˜ê¸°</h1>
            <div class="w-full mb-4">
                <label for="session-id-input" class="block text-lg font-medium text-gray-700 mb-2">ìˆ˜ì—… ID</label>
                <input type="number" id="session-id-input" class="w-full p-3 text-center text-2xl border-2 border-gray-300 rounded-lg" placeholder="ì˜ˆ: 1234">
            </div>
            <div class="w-full mb-6">
                <label for="team-name-input" class="block text-lg font-medium text-gray-700 mb-2">ëª¨ë‘ (íŒ€) ì´ë¦„</label>
                <input type="text" id="team-name-input" class="w-full p-3 text-center text-2xl border-2 border-gray-300 rounded-lg" placeholder="ì˜ˆ: 1ëª¨ë‘ ">
            </div>
            <button id="join-btn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl text-xl hover:bg-indigo-700 transition">ì°¸ê°€í•˜ê¸°</button>
            <p id="error-message" class="text-red-500 mt-4 h-6"></p>
        </div>

        <!-- ìŠ¤í¬ë¦° 2: ê²Œì„ -->
        <div id="buzzer-screen" class="screen hidden flex-col items-center">
            <div class="w-full bg-white p-4 rounded-xl shadow-md mb-4 text-center">
                <h2 class="text-xl font-bold"><span id="my-team-name" class="text-indigo-600"></span> ëª¨ë‘ </h2>
            </div>
            <!-- ì ìˆ˜íŒ -->
            <div class="w-full bg-white p-4 rounded-xl shadow-md mb-4">
                <h3 class="text-lg font-bold text-center mb-2">ğŸ† ì ìˆ˜íŒ</h3>
                <ul id="scoreboard-student" class="space-y-1 text-sm">
                    <!-- JSë¡œ ìƒì„± -->
                </ul>
            </div>
            <div id="buzzer-container" class="w-full">
                <button id="buzzer-btn" class="w-full h-64 rounded-2xl text-5xl font-bold transition-colors duration-300 flex items-center justify-center" disabled>
                    <span id="buzzer-text">ëŒ€ê¸° ì¤‘...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // --- 1. ì œê°€ í•´ì•¼ í•  ì¼: ì—¬ê¸°ì— Firebase ì„¤ì •ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaEEBdKzMONv9f8YgTWLK4s2PJFjTM31Q",
            authDomain: "card-game-class.firebaseapp.com",
            projectId: "card-game-class",
            storageBucket: "card-game-class.firebasestorage.app",
            messagingSenderId: "620033523838",
            appId: "1:620033523838:web:6e37f0e6b4d0bab7b1d82f",
            measurementId: "G-F9JV9Z17QF"
        };
        // -------------------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- ì˜¤ë””ì˜¤ ê°ì²´ ---
        const startSound = new Audio('start.mp3');

        // --- DOM ìš”ì†Œ ---
        const joinScreen = document.getElementById('join-screen');
        const buzzerScreen = document.getElementById('buzzer-screen');
        const sessionIdInput = document.getElementById('session-id-input');
        const teamNameInput = document.getElementById('team-name-input');
        const joinBtn = document.getElementById('join-btn');
        const errorMessage = document.getElementById('error-message');
        const myTeamName = document.getElementById('my-team-name');
        const buzzerBtn = document.getElementById('buzzer-btn');
        const buzzerText = document.getElementById('buzzer-text');
        const scoreboardStudent = document.getElementById('scoreboard-student');

        // --- ê²Œì„ ìƒíƒœ ë³€ìˆ˜ ---
        let currentSessionId = null;
        let myTeam = null;
        let sessionUnsubscribe = null;

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        joinBtn.addEventListener('click', joinSession);
        buzzerBtn.addEventListener('click', buzz);

        // --- í•¨ìˆ˜ ---
        async function joinSession() {
            const sessionId = sessionIdInput.value.trim();
            const teamName = teamNameInput.value.trim();

            if (!sessionId || !teamName) {
                errorMessage.textContent = 'ìˆ˜ì—… IDì™€ ëª¨ë‘  ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.';
                return;
            }

            const sessionRef = db.collection('sessions').doc(sessionId);
            const doc = await sessionRef.get();

            if (!doc.exists) {
                errorMessage.textContent = 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìˆ˜ì—… IDì…ë‹ˆë‹¤.';
                return;
            }
            
            errorMessage.textContent = '';
            myTeam = teamName;
            currentSessionId = sessionId;
            myTeamName.textContent = myTeam;

            // íŒ€ ì •ë³´ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
            const teamData = { score: 0 };
            await sessionRef.set({ teams: { [myTeam]: teamData } }, { merge: true });

            joinScreen.classList.remove('active');
            buzzerScreen.classList.add('active');
            listenToSession();
        }
        
        function listenToSession() {
            if (sessionUnsubscribe) sessionUnsubscribe();
            sessionUnsubscribe = db.collection('sessions').doc(currentSessionId)
                .onSnapshot(doc => {
                    const data = doc.data();
                    if (!data) return; // ì„¸ì…˜ì´ ì‚­ì œëœ ê²½ìš°
                    updateBuzzerState(data.gameState, data.buzzerOrder);
                    updateScoreboard(data.teams);
                });
        }
        
        let buzzedThisRound = false;
        function updateBuzzerState(gameState, buzzerOrder) {
            const iHaveBuzzed = buzzerOrder.some(b => b.teamName === myTeam);
            
            switch (gameState) {
                case 'waiting':
                    buzzerBtn.disabled = true;
                    buzzerText.textContent = 'ëŒ€ê¸° ì¤‘...';
                    buzzerBtn.className = 'w-full h-64 rounded-2xl text-5xl font-bold bg-gray-400 text-white';
                    buzzedThisRound = false;
                    break;
                case 'question':
                    if (!buzzedThisRound) {
                        startSound.play();
                    }
                    if (iHaveBuzzed) {
                         buzzerBtn.disabled = true;
                         buzzerText.textContent = 'ì™„ë£Œ';
                         buzzerBtn.className = 'w-full h-64 rounded-2xl text-5xl font-bold bg-indigo-500 text-white';
                    } else {
                         buzzerBtn.disabled = false;
                         buzzerText.textContent = 'ì¢… ëˆ„ë¥´ê¸°!';
                         buzzerBtn.className = 'w-full h-64 rounded-2xl text-5xl font-bold bg-yellow-400 text-gray-800 hover:bg-yellow-500 active:scale-95';
                    }
                    break;
                case 'scoring':
                     buzzerBtn.disabled = true;
                     buzzerText.textContent = 'ê²°ê³¼ í™•ì¸';
                     buzzerBtn.className = 'w-full h-64 rounded-2xl text-5xl font-bold bg-blue-300 text-white';
                    break;
            }
        }
        
        function updateScoreboard(teams) {
            scoreboardStudent.innerHTML = '';
            const sortedTeams = Object.entries(teams).sort(([, a], [, b]) => b.score - a.score);
             if (sortedTeams.length === 0) {
                 return;
            }
            sortedTeams.forEach(([teamName, teamData]) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-1 bg-white rounded';
                li.innerHTML = `<span class="font-medium">${teamName}</span><span class="font-bold text-indigo-600">${teamData.score}ì </span>`;
                scoreboardStudent.appendChild(li);
            });
        }

        async function buzz() {
            if (!currentSessionId || !myTeam) return;
            buzzerBtn.disabled = true;
            buzzedThisRound = true;
            
            const sessionRef = db.collection('sessions').doc(currentSessionId);
            
            // --- ìˆ˜ì •ëœ ë¶€ë¶„ ---
            // ì–´ë–¤ íŒ€ì´(myTeam), ì–¸ì œ(serverTimestamp) ëˆŒë €ëŠ”ì§€
            // ê°ì²´ í˜•íƒœë¡œ ì •í™•íˆ ì „ë‹¬í•©ë‹ˆë‹¤.
            await sessionRef.update({
                buzzerOrder: firebase.firestore.FieldValue.arrayUnion({
                    teamName: myTeam,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            });
        }
    </script>
</body>
</html>
