<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스포츠클럽 배정 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 커스텀 스크롤바 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 드래그 중인 학생 카드 스타일 */
        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        /* 드롭 영역 하이라이트 */
        .drag-over {
            border-style: dashed;
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6">
        <!-- 네비게이션 -->
        <nav class="bg-white rounded-lg shadow-md p-4 mb-6 flex justify-center items-center space-x-4">
            <h1 class="text-xl md:text-2xl font-bold text-gray-700 hidden sm:block">스포츠클럽 배정</h1>
            <button id="nav-assignment" class="px-4 py-2 rounded-md text-sm font-semibold bg-blue-500 text-white shadow-sm hover:bg-blue-600 transition-colors">학생 배정</button>
            <button id="nav-management" class="px-4 py-2 rounded-md text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">명단 관리</button>
        </nav>

        <!-- 페이지 1: 학생 배정 -->
        <main id="assignment-page">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- 왼쪽: 부서 목록 -->
                <div class="w-full md:w-3/5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">부서 목록</h2>
                        <div class="flex space-x-2">
                            <button id="confirm-btn" class="px-3 py-1.5 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition-colors text-xs">배정 확정</button>
                            <button id="reset-btn" class="px-3 py-1.5 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors text-xs">배정 초기화</button>
                            <button id="save-image-btn" class="px-3 py-1.5 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition-colors text-xs">이미지로 저장</button>
                        </div>
                    </div>
                    <div id="departments-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- 부서 카드가 여기에 동적으로 생성됩니다. -->
                    </div>
                </div>

                <!-- 오른쪽: 미배정 학생 목록 (Sticky) -->
                <aside class="w-full md:w-2/5 md:sticky top-6 self-start">
                    <div id="unassigned-container" class="bg-white p-4 rounded-lg shadow-md h-full min-h-[200px] border-2 border-transparent transition-all">
                        <h2 class="text-xl font-bold mb-4 text-center">미배정 학생</h2>
                        <div id="unassigned-students-list" class="grid grid-cols-3 gap-2">
                            <!-- 미배정 학생 카드가 여기에 동적으로 생성됩니다. -->
                        </div>
                    </div>
                </aside>
            </div>
        </main>

        <!-- 페이지 2: 명단 관리 -->
        <main id="management-page" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 부서 관리 -->
                <section id="department-management" class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">부서 관리</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="dept-name-input" class="block text-sm font-medium text-gray-700">개별 추가</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="dept-name-input" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="부서명">
                                <button id="add-dept-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm hover:bg-gray-100">추가</button>
                            </div>
                        </div>
                        <div>
                            <label for="dept-bulk-input" class="block text-sm font-medium text-gray-700">일괄 등록 (한 줄에 하나씩)</label>
                            <textarea id="dept-bulk-input" rows="4" class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="축구&#10;농구&#10;탁구"></textarea>
                            <button id="add-dept-bulk-btn" class="mt-2 w-full px-4 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors text-sm">일괄 추가</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold">부서 목록</h3>
                            <ul id="dept-list" class="mt-2 border border-gray-200 rounded-md divide-y divide-gray-200 max-h-60 overflow-y-auto"></ul>
                            <button id="delete-all-depts-btn" class="mt-2 w-full px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors text-sm">전체 삭제</button>
                        </div>
                    </div>
                </section>

                <!-- 학생 관리 -->
                <section id="student-management" class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">학생 관리</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="student-name-input" class="block text-sm font-medium text-gray-700">개별 추가</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="student-name-input" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="학생 이름">
                                <button id="add-student-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm hover:bg-gray-100">추가</button>
                            </div>
                        </div>
                        <div>
                            <label for="student-bulk-input" class="block text-sm font-medium text-gray-700">일괄 등록 (한 줄에 하나씩)</label>
                            <textarea id="student-bulk-input" rows="4" class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="학생1&#10;학생2&#10;학생3"></textarea>
                            <button id="add-student-bulk-btn" class="mt-2 w-full px-4 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors text-sm">일괄 추가</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold">학생 목록</h3>
                            <ul id="student-list" class="mt-2 border border-gray-200 rounded-md divide-y divide-gray-200 max-h-60 overflow-y-auto"></ul>
                            <button id="delete-all-students-btn" class="mt-2 w-full px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors text-sm">전체 삭제</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- 랜덤 배정 모달 -->
    <div id="random-assign-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-4">랜덤 배정: <span id="modal-dept-name" class="text-blue-600"></span></h2>
            <div class="mb-4">
                <label for="random-count" class="block text-sm font-medium text-gray-700">배정할 인원 수</label>
                <input type="number" id="random-count" min="1" class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md" placeholder="예: 3">
            </div>
            <div class="flex justify-end space-x-2 mb-4">
                <button id="reassign-gray-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition-colors text-sm">회색만 재배정</button>
                <button id="reassign-all-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition-colors text-sm">전체 재배정</button>
            </div>
            <div id="modal-result" class="bg-gray-100 p-3 rounded-md text-sm min-h-[50px]">
                결과가 여기에 표시됩니다.
            </div>
            <div class="mt-6 text-right">
                <button id="close-modal-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors">닫기</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 요소 ---
            const app = {
                pages: {
                    assignment: document.getElementById('assignment-page'),
                    management: document.getElementById('management-page'),
                },
                nav: {
                    assignment: document.getElementById('nav-assignment'),
                    management: document.getElementById('nav-management'),
                },
                assignment: {
                    departmentsContainer: document.getElementById('departments-container'),
                    unassignedContainer: document.getElementById('unassigned-container'),
                    unassignedList: document.getElementById('unassigned-students-list'),
                    confirmBtn: document.getElementById('confirm-btn'),
                    resetBtn: document.getElementById('reset-btn'),
                    saveImageBtn: document.getElementById('save-image-btn'),
                },
                management: {
                    deptNameInput: document.getElementById('dept-name-input'),
                    addDeptBtn: document.getElementById('add-dept-btn'),
                    deptBulkInput: document.getElementById('dept-bulk-input'),
                    addDeptBulkBtn: document.getElementById('add-dept-bulk-btn'),
                    deptList: document.getElementById('dept-list'),
                    deleteAllDeptsBtn: document.getElementById('delete-all-depts-btn'),
                    studentNameInput: document.getElementById('student-name-input'),
                    addStudentBtn: document.getElementById('add-student-btn'),
                    studentBulkInput: document.getElementById('student-bulk-input'),
                    addStudentBulkBtn: document.getElementById('add-student-bulk-btn'),
                    studentList: document.getElementById('student-list'),
                    deleteAllStudentsBtn: document.getElementById('delete-all-students-btn'),
                },
                modal: {
                    element: document.getElementById('random-assign-modal'),
                    deptName: document.getElementById('modal-dept-name'),
                    countInput: document.getElementById('random-count'),
                    reassignGrayBtn: document.getElementById('reassign-gray-btn'),
                    reassignAllBtn: document.getElementById('reassign-all-btn'),
                    result: document.getElementById('modal-result'),
                    closeBtn: document.getElementById('close-modal-btn'),
                }
            };

            // --- 상태 관리 ---
            let state = {
                departments: [],
                students: [],
                assignments: {}, // { "부서명": [{name: "학생", status: "pending|confirmed"}], "unassigned": [...] }
                draggedStudent: null,
                modalTargetDept: null,
            };

            // --- 데이터 저장 및 로드 ---
            const saveData = () => {
                localStorage.setItem('sportsClubData', JSON.stringify(state));
            };

            const loadData = () => {
                const data = localStorage.getItem('sportsClubData');
                if (data) {
                    state = JSON.parse(data);
                } else {
                    // 초기 데이터
                    state.departments = ['축구', '농구', '탁구', '배드민턴', '피구', '트레킹'];
                    state.students = ['학생1', '학생2', '학생3', '학생4', '학생5', '학생6', '학생7', '학생8'];
                    state.assignments = { unassigned: state.students.map(name => ({ name, status: 'pending' })) };
                    state.departments.forEach(dept => {
                        state.assignments[dept] = [];
                    });
                    saveData();
                }
            };

            // --- 렌더링 함수 ---
            const render = () => {
                renderAssignmentPage();
                renderManagementPage();
            };

            const renderAssignmentPage = () => {
                // 부서 목록 렌더링
                app.assignment.departmentsContainer.innerHTML = '';
                state.departments.forEach(deptName => {
                    const deptCard = document.createElement('div');
                    deptCard.className = 'bg-white p-4 rounded-lg shadow-md border-2 border-transparent transition-all min-h-[150px]';
                    deptCard.dataset.deptName = deptName;

                    const title = document.createElement('h3');
                    title.className = 'text-lg font-bold mb-3 text-center cursor-pointer hover:text-blue-600';
                    title.textContent = deptName;
                    title.onclick = () => openRandomAssignModal(deptName);
                    
                    const studentList = document.createElement('div');
                    studentList.className = 'grid grid-cols-2 gap-2 student-list-container';
                    studentList.dataset.deptName = deptName;

                    const assignedStudents = state.assignments[deptName] || [];
                    assignedStudents.forEach(student => {
                        studentList.appendChild(createStudentCard(student));
                    });

                    deptCard.appendChild(title);
                    deptCard.appendChild(studentList);
                    app.assignment.departmentsContainer.appendChild(deptCard);
                });

                // 미배정 학생 목록 렌더링
                app.assignment.unassignedList.innerHTML = '';
                const unassignedStudents = state.assignments.unassigned || [];
                unassignedStudents.forEach(student => {
                    app.assignment.unassignedList.appendChild(createStudentCard(student));
                });

                addDragAndDropListeners();
            };
            
            const createStudentCard = (student) => {
                const card = document.createElement('div');
                card.draggable = true;
                card.dataset.studentName = student.name;
                card.textContent = student.name;
                card.className = `p-2 rounded text-center text-xs md:text-sm font-semibold cursor-grab shadow-sm transition-all
                    ${student.status === 'confirmed' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-800'}`;
                return card;
            };

            const renderManagementPage = () => {
                // 부서 목록
                app.management.deptList.innerHTML = '';
                state.departments.forEach(deptName => {
                    const li = document.createElement('li');
                    li.className = 'px-4 py-2 flex justify-between items-center';
                    li.textContent = deptName;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '삭제';
                    deleteBtn.className = 'px-2 py-1 bg-red-100 text-red-700 text-xs rounded hover:bg-red-200';
                    deleteBtn.onclick = () => deleteDepartment(deptName);
                    li.appendChild(deleteBtn);
                    app.management.deptList.appendChild(li);
                });

                // 학생 목록
                app.management.studentList.innerHTML = '';
                state.students.forEach(studentName => {
                    const li = document.createElement('li');
                    li.className = 'px-4 py-2 flex justify-between items-center';
                    li.textContent = studentName;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '삭제';
                    deleteBtn.className = 'px-2 py-1 bg-red-100 text-red-700 text-xs rounded hover:bg-red-200';
                    deleteBtn.onclick = () => deleteStudent(studentName);
                    li.appendChild(deleteBtn);
                    app.management.studentList.appendChild(li);
                });
            };

            // --- 드래그 앤 드롭 로직 ---
            const addDragAndDropListeners = () => {
                const studentCards = document.querySelectorAll('[draggable="true"]');
                const dropZones = [app.assignment.unassignedContainer, ...document.querySelectorAll('[data-dept-name]')];

                studentCards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        state.draggedStudent = e.target.dataset.studentName;
                        setTimeout(() => e.target.classList.add('dragging'), 0);
                    });
                    card.addEventListener('dragend', (e) => {
                        e.target.classList.remove('dragging');
                        state.draggedStudent = null;
                    });
                });

                dropZones.forEach(zone => {
                    zone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        zone.classList.add('drag-over');
                    });
                    zone.addEventListener('dragleave', () => {
                        zone.classList.remove('drag-over');
                    });
                    zone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        zone.classList.remove('drag-over');
                        if (!state.draggedStudent) return;

                        const studentName = state.draggedStudent;
                        const targetDept = zone.dataset.deptName || 'unassigned';

                        // 1. 기존 위치에서 학생 제거
                        let studentData;
                        for (const dept in state.assignments) {
                            const index = state.assignments[dept].findIndex(s => s.name === studentName);
                            if (index > -1) {
                                studentData = state.assignments[dept].splice(index, 1)[0];
                                break;
                            }
                        }
                        
                        // 2. 새로운 위치에 학생 추가
                        if (studentData) {
                            studentData.status = 'pending'; // 부서 이동 시 항상 pending 상태로
                            if (targetDept === 'unassigned') {
                                state.assignments.unassigned.push(studentData);
                            } else {
                                state.assignments[targetDept].push(studentData);
                            }
                        }

                        saveData();
                        renderAssignmentPage();
                    });
                });
            };

            // --- 페이지 전환 ---
            const switchPage = (pageToShow) => {
                if (pageToShow === 'assignment') {
                    app.pages.assignment.classList.remove('hidden');
                    app.pages.management.classList.add('hidden');
                    app.nav.assignment.classList.replace('bg-gray-200', 'bg-blue-500');
                    app.nav.assignment.classList.replace('text-gray-700', 'text-white');
                    app.nav.management.classList.replace('bg-blue-500', 'bg-gray-200');
                    app.nav.management.classList.replace('text-white', 'text-gray-700');
                    renderAssignmentPage();
                } else {
                    app.pages.assignment.classList.add('hidden');
                    app.pages.management.classList.remove('hidden');
                    app.nav.management.classList.replace('bg-gray-200', 'bg-blue-500');
                    app.nav.management.classList.replace('text-gray-700', 'text-white');
                    app.nav.assignment.classList.replace('bg-blue-500', 'bg-gray-200');
                    app.nav.assignment.classList.replace('text-white', 'text-gray-700');
                    renderManagementPage();
                }
            };

            // --- '학생 배정' 페이지 기능 ---
            app.assignment.confirmBtn.addEventListener('click', () => {
                state.departments.forEach(dept => {
                    if (state.assignments[dept]) {
                        state.assignments[dept].forEach(student => {
                            student.status = 'confirmed';
                        });
                    }
                });
                saveData();
                renderAssignmentPage();
            });

            // --- [FIXED & IMPROVED] 배정 초기화 로직 수정 ---
            app.assignment.resetBtn.addEventListener('click', () => {
                if (confirm('모든 배정을 초기화 하시겠습니까?')) {
                    // 1. 현재 배정된 모든 학생(부서+미배정)을 하나의 배열로 모읍니다.
                    let allAssignedStudents = [];
                    for (const key in state.assignments) {
                        allAssignedStudents = allAssignedStudents.concat(state.assignments[key]);
                    }
                    
                    // 2. 중복을 제거하여 순수한 학생 이름 목록을 만듭니다.
                    const allStudentNames = [...new Set(allAssignedStudents.map(s => s.name))];

                    // 3. 이 최종 명단을 '전체 학생 명단'으로 업데이트하여 데이터를 동기화합니다.
                    state.students = allStudentNames;

                    // 4. 최종 명단을 기반으로 모든 학생을 미배정 처리합니다.
                    state.assignments.unassigned = state.students.map(studentName => ({
                        name: studentName,
                        status: 'pending'
                    }));

                    // 5. 모든 부서의 학생 목록을 비웁니다.
                    state.departments.forEach(deptName => {
                        state.assignments[deptName] = [];
                    });

                    saveData();
                    renderAssignmentPage();
                }
            });


            app.assignment.saveImageBtn.addEventListener('click', () => {
                // 이미지 저장 시 잠시 스타일 변경
                const unassignedContainer = app.assignment.unassignedContainer;
                const originalPosition = unassignedContainer.style.position;
                unassignedContainer.style.position = 'relative'; // sticky 해제

                html2canvas(document.getElementById('assignment-page')).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'sports-club-assignment.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    // 스타일 원복
                    unassignedContainer.style.position = originalPosition;
                });
            });

            // --- '명단 관리' 페이지 기능 ---
            const addDepartment = (name) => {
                if (name && !state.departments.includes(name)) {
                    state.departments.push(name);
                    state.assignments[name] = [];
                    return true;
                }
                return false;
            };

            const addStudent = (name) => {
                if (name && !state.students.includes(name)) {
                    state.students.push(name);
                    state.assignments.unassigned.push({ name, status: 'pending' });
                    return true;
                }
                return false;
            };
            
            const deleteDepartment = (name) => {
                if (!confirm(`'${name}' 부서를 삭제하시겠습니까?\n배정된 학생은 모두 미배정 상태가 됩니다.`)) return;
                state.departments = state.departments.filter(d => d !== name);
                const studentsToUnassign = state.assignments[name] || [];
                studentsToUnassign.forEach(s => s.status = 'pending');
                state.assignments.unassigned.push(...studentsToUnassign);
                delete state.assignments[name];
                saveData();
                renderManagementPage();
            };

            const deleteStudent = (name) => {
                if (!confirm(`'${name}' 학생을 명단에서 삭제하시겠습니까?`)) return;
                state.students = state.students.filter(s => s !== name);
                for (const dept in state.assignments) {
                    state.assignments[dept] = state.assignments[dept].filter(s => s.name !== name);
                }
                saveData();
                renderManagementPage();
            };

            app.management.addDeptBtn.addEventListener('click', () => {
                const name = app.management.deptNameInput.value.trim();
                if (addDepartment(name)) {
                    saveData();
                    renderManagementPage();
                    app.management.deptNameInput.value = '';
                } else {
                    alert('부서명이 비어있거나 이미 존재합니다.');
                }
            });

            app.management.addDeptBulkBtn.addEventListener('click', () => {
                const names = app.management.deptBulkInput.value.split('\n').map(n => n.trim()).filter(Boolean);
                let addedCount = 0;
                names.forEach(name => {
                    if (addDepartment(name)) addedCount++;
                });
                if (addedCount > 0) {
                    saveData();
                    renderManagementPage();
                    app.management.deptBulkInput.value = '';
                    alert(`${addedCount}개의 부서가 추가되었습니다.`);
                }
            });

            app.management.deleteAllDeptsBtn.addEventListener('click', () => {
                if (!confirm('모든 부서를 삭제하시겠습니까?')) return;
                state.departments.forEach(deptName => {
                    const studentsToUnassign = state.assignments[deptName] || [];
                    studentsToUnassign.forEach(s => s.status = 'pending');
                    state.assignments.unassigned.push(...studentsToUnassign);
                    delete state.assignments[deptName];
                });
                state.departments = [];
                saveData();
                renderManagementPage();
            });

            app.management.addStudentBtn.addEventListener('click', () => {
                const name = app.management.studentNameInput.value.trim();
                if (addStudent(name)) {
                    saveData();
                    renderManagementPage();
                    app.management.studentNameInput.value = '';
                } else {
                    alert('학생 이름이 비어있거나 이미 존재합니다.');
                }
            });

            app.management.addStudentBulkBtn.addEventListener('click', () => {
                const names = app.management.studentBulkInput.value.split('\n').map(n => n.trim()).filter(Boolean);
                let addedCount = 0;
                names.forEach(name => {
                    if (addStudent(name)) addedCount++;
                });
                if (addedCount > 0) {
                    saveData();
                    renderManagementPage();
                    app.management.studentBulkInput.value = '';
                    alert(`${addedCount}명의 학생이 추가되었습니다.`);
                }
            });

            app.management.deleteAllStudentsBtn.addEventListener('click', () => {
                if (!confirm('모든 학생을 삭제하시겠습니까?')) return;
                state.students = [];
                state.assignments = { unassigned: [] };
                state.departments.forEach(dept => {
                    state.assignments[dept] = [];
                });
                saveData();
                renderManagementPage();
            });
            
            // --- 랜덤 배정 모달 기능 ---
            const openRandomAssignModal = (deptName) => {
                state.modalTargetDept = deptName;
                app.modal.deptName.textContent = deptName;
                app.modal.countInput.value = '';
                app.modal.result.textContent = '결과가 여기에 표시됩니다.';
                app.modal.element.classList.remove('hidden');
            };

            const closeRandomAssignModal = () => {
                app.modal.element.classList.add('hidden');
                state.modalTargetDept = null;
                renderAssignmentPage(); // 모달 닫을 때 메인 화면 갱신
            };

            const performRandomAssignment = (reassignAll) => {
                const deptName = state.modalTargetDept;
                const count = parseInt(app.modal.countInput.value, 10);
                const currentStudents = state.assignments[deptName] || [];

                if (isNaN(count) || count < 0) {
                    alert('유효한 인원 수를 입력하세요.');
                    return;
                }

                let pool;
                if (reassignAll) {
                    pool = [...currentStudents];
                    state.assignments[deptName] = []; // 기존 학생 모두 제거
                } else { // 회색만
                    pool = currentStudents.filter(s => s.status === 'pending');
                    // 파란색(확정) 학생은 그대로 둠
                    state.assignments[deptName] = currentStudents.filter(s => s.status === 'confirmed');
                }

                if (count > pool.length) {
                    alert(`배정 가능 인원(${pool.length}명)을 초과했습니다.`);
                    return;
                }
                
                // Fisher-Yates shuffle
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }

                const assigned = pool.slice(0, count);
                const unassigned = pool.slice(count);

                assigned.forEach(s => s.status = 'pending');
                unassigned.forEach(s => s.status = 'pending');

                state.assignments[deptName].push(...assigned);
                state.assignments.unassigned.push(...unassigned);

                saveData();
                
                // 결과 표시
                const assignedNames = assigned.map(s => s.name).join(', ') || '없음';
                const unassignedNames = unassigned.map(s => s.name).join(', ') || '없음';
                app.modal.result.innerHTML = `
                    <p><strong class="font-semibold">배정:</strong> ${assignedNames}</p>
                    <p><strong class="font-semibold">미배정:</strong> ${unassignedNames}</p>
                `;
            };

            app.modal.reassignAllBtn.addEventListener('click', () => performRandomAssignment(true));
            app.modal.reassignGrayBtn.addEventListener('click', () => performRandomAssignment(false));
            app.modal.closeBtn.addEventListener('click', closeRandomAssignModal);

            // --- 초기화 ---
            app.nav.assignment.addEventListener('click', () => switchPage('assignment'));
            app.nav.management.addEventListener('click', () => switchPage('management'));
            
            // 엔터 키로 추가
            app.management.deptNameInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') app.management.addDeptBtn.click();
            });
            app.management.studentNameInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') app.management.addStudentBtn.click();
            });

            loadData();
            render();
        });
    </script>
</body>
</html>
