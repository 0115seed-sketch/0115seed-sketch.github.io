<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자리 바꾸기 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .nav-link.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .desk {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .desk:not(.locked):hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .desk.selected {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px #60a5fa; /* ring-blue-400 */
        }
        .desk.locked {
            background-color: #fca5a5 !important; /* red-300 */
            color: #7f1d1d; /* red-900 */
        }
        #countdown-overlay, #teacher-preset-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 9999;
        }
        #countdown-text {
            font-size: 15rem;
            color: white;
            font-weight: 700;
            animation: countdown-pulse 1s infinite;
        }
        @keyframes countdown-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- 네비게이션 -->
        <nav class="flex bg-white rounded-lg shadow-sm mb-4">
            <a id="nav-main" class="nav-link flex-1 py-3 px-2 text-center font-bold text-gray-600 cursor-pointer border-b-4 border-transparent active">자리 배치</a>
            <a id="nav-settings" class="nav-link flex-1 py-3 px-2 text-center font-bold text-gray-600 cursor-pointer border-b-4 border-transparent">설정</a>
        </nav>

        <!-- 페이지 1: 자리 배치 -->
        <div id="page-main" class="page">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">자리 배치도</h2>
                    <div class="flex items-center gap-2">
                        <!-- [추가] 교사 시점 버튼 추가 -->
                        <button id="toggle-view-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">👩‍🏫 교사 시점</button>
                        <button id="randomize-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">🎲 랜덤 배치</button>
                        <button id="save-image-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">🖼️ 이미지로 저장</button>
                    </div>
                </div>
                <div id="seating-chart-area">
                    <!-- [추가] 교탁에 ID 부여 -->
                    <div id="teacher-desk" class="w-1/3 mx-auto mb-8 p-4 bg-yellow-200 border-2 border-yellow-400 rounded-lg text-center font-bold text-yellow-800">교탁</div>
                    <div id="seating-chart-container" class="flex justify-around gap-4"></div>
                </div>
                 <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-2">💡 사용 방법</h3>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                        <li><strong>자리 바꾸기:</strong> 바꿀 두 학생의 자리를 차례로 클릭하세요.</li>
                        <li><strong>자리 고정하기:</strong> 학생 자리를 <kbd>Shift</kbd> 키를 누른 채 클릭하여 고정/해제할 수 있습니다.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 페이지 2: 설정 -->
        <div id="page-settings" class="page hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">설정</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">학생 명단</h3>
                        <p class="text-sm text-gray-500 mb-3">번호와 이름을 한 줄에 한 명씩 입력하세요.</p>
                        <textarea id="student-list" rows="12" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400" placeholder="1 이서연&#10;2 박도윤&#10;..."></textarea>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">자리 배치도 수정</h3>
                        <p class="text-sm text-gray-500 mb-3">클릭하여 책상(⬛)과 빈 공간(⬜)을 설정하세요.</p>
                        <div id="layout-editor" class="grid grid-cols-6 gap-2 p-4 bg-gray-100 rounded-md"></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end items-center gap-3">
                    <span id="save-feedback" class="text-green-600 font-semibold transition-opacity duration-300 opacity-0">설정이 저장되었습니다!</span>
                    <button id="teacher-preset-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">👨‍🏫 교사 설정 자리</button>
                    <button id="save-settings-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">💾 설정 저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 카운트다운 오버레이 -->
    <div id="countdown-overlay" class="hidden justify-center items-center">
        <div id="countdown-text"></div>
    </div>

    <!-- 교사 설정 자리 모달 -->
    <div id="teacher-preset-modal" class="hidden justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h2 class="text-xl font-bold text-gray-800 p-4 border-b">교사 설정 자리</h2>
            <div class="p-4 overflow-y-auto">
                <div id="teacher-preset-editor-container" class="flex justify-around gap-4"></div>
                 <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="font-semibold text-blue-800 mb-2">💡 사용 방법</h3>
                    <p class="text-sm text-blue-700">자리 배치 페이지에서 <kbd>Ctrl</kbd>키를 누르고 '랜덤 배정' 버튼을 누르면, 현재 설정된 자리로 배치됩니다.<br>단, 이미 빨간색으로 고정된 자리가 있다면, 이 기능은 작동하지 않습니다.</p>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end gap-3 bg-gray-50">
                <button id="close-preset-modal-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">닫기</button>
                <button id="save-preset-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">저장</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const pages = { main: document.getElementById('page-main'), settings: document.getElementById('page-settings') };
    const navs = { main: document.getElementById('nav-main'), settings: document.getElementById('nav-settings') };
    const studentListTextArea = document.getElementById('student-list');
    const layoutEditor = document.getElementById('layout-editor');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const seatingChartContainer = document.getElementById('seating-chart-container');
    const randomizeBtn = document.getElementById('randomize-btn');
    const saveImageBtn = document.getElementById('save-image-btn');
    const countdownOverlay = document.getElementById('countdown-overlay');
    const countdownText = document.getElementById('countdown-text');
    const teacherPresetBtn = document.getElementById('teacher-preset-btn');
    const teacherPresetModal = document.getElementById('teacher-preset-modal');
    const closePresetModalBtn = document.getElementById('close-preset-modal-btn');
    const savePresetBtn = document.getElementById('save-preset-btn');
    const teacherPresetEditorContainer = document.getElementById('teacher-preset-editor-container');
    const saveFeedback = document.getElementById('save-feedback');
    // [추가] 교사 시점 전환 관련 DOM 요소
    const toggleViewBtn = document.getElementById('toggle-view-btn');
    const seatingChartArea = document.getElementById('seating-chart-area');
    const teacherDesk = document.getElementById('teacher-desk');

    // App State
    let students = [];
    let layout = [];
    let seatAssignments = [];
    let teacherPresetAssignments = [];
    let selectedDesk = null;
    let selectedPresetDesk = null;
    // [추가] 교사 시점 상태를 저장하는 변수
    let isTeacherView = false;

    const DEFAULT_LAYOUT = Array.from({ length: 36 }, (_, i) => ({ isDesk: true, id: i }));
    const DEFAULT_STUDENTS_TEXT = Array.from({length: 36}, (_, i) => `${i+1} 학생${i+1}`).join('\n');

    function switchPage(pageName) {
        Object.values(pages).forEach(p => p.classList.add('hidden'));
        Object.values(navs).forEach(n => n.classList.remove('active'));
        pages[pageName].classList.remove('hidden');
        navs[pageName].classList.add('active');
    }

    function saveSettings() {
        students = studentListTextArea.value.split('\n').map(line => line.trim()).filter(Boolean).map((line, index) => {
            const parts = line.split(/\s+/);
            const id = parts[0];
            const name = parts.slice(1).join(' ');
            return { id: id || (index + 1), name: name || line };
        });
        localStorage.setItem('students', JSON.stringify(students));
        const deskElements = Array.from(layoutEditor.children);
        layout = deskElements.map((desk, i) => ({ isDesk: desk.dataset.isDesk === 'true', id: i }));
        localStorage.setItem('layout', JSON.stringify(layout));
        
        saveFeedback.classList.remove('opacity-0');
        setTimeout(() => {
            saveFeedback.classList.add('opacity-0');
        }, 2000);
        
        initializeMainPage();
    }

    function loadSettings() {
        const savedStudentsStr = localStorage.getItem('students');
        const savedLayoutStr = localStorage.getItem('layout');
        const savedPresetStr = localStorage.getItem('teacherPresetAssignments');

        students = savedStudentsStr ? JSON.parse(savedStudentsStr) : DEFAULT_STUDENTS_TEXT.split('\n').map((line) => {
            const parts = line.split(/\s+/);
            return { id: parts[0], name: parts.slice(1).join(' ') };
        });
        studentListTextArea.value = students.map(s => `${s.id} ${s.name}`).join('\n');

        layout = savedLayoutStr ? JSON.parse(savedLayoutStr) : DEFAULT_LAYOUT;
        teacherPresetAssignments = savedPresetStr ? JSON.parse(savedPresetStr) : [];
    }

    function renderLayoutEditor() {
        layoutEditor.innerHTML = '';
        layout.forEach(cell => {
            const cellDiv = document.createElement('div');
            cellDiv.className = 'w-12 h-12 border flex items-center justify-center cursor-pointer';
            cellDiv.dataset.id = cell.id;
            cellDiv.dataset.isDesk = cell.isDesk;
            cellDiv.style.backgroundColor = cell.isDesk ? '#9ca3af' : '#f3f4f6';
            cellDiv.addEventListener('click', () => {
                cellDiv.dataset.isDesk = cellDiv.dataset.isDesk === 'true' ? 'false' : 'true';
                cellDiv.style.backgroundColor = cellDiv.dataset.isDesk === 'true' ? '#9ca3af' : '#f3f4f6';
            });
            layoutEditor.appendChild(cellDiv);
        });
    }

    function initializeMainPage() {
        const deskCells = layout.filter(c => c.isDesk);
        const oldAssignments = JSON.parse(localStorage.getItem('seatAssignments')) || [];
        const newAssignments = [];
        const availableStudents = [...students];

        deskCells.forEach(desk => {
            const oldAssignment = oldAssignments.find(a => a.deskId === desk.id);
            let studentId = null;
            let locked = false;
            if (oldAssignment) {
                const studentIndex = availableStudents.findIndex(s => s.id == oldAssignment.studentId);
                if (studentIndex > -1) {
                    studentId = oldAssignment.studentId;
                    availableStudents.splice(studentIndex, 1);
                }
                locked = oldAssignment.locked;
            }
            newAssignments.push({ deskId: desk.id, studentId: studentId, locked: locked });
        });

        newAssignments.forEach(assignment => {
            if (assignment.studentId === null && availableStudents.length > 0) {
                assignment.studentId = availableStudents.shift().id;
            }
        });
        seatAssignments = newAssignments;
        renderSeatingChart(seatingChartContainer, seatAssignments);
        saveAssignments();
    }
    
    // [추가] 교사/학생 시점 전환 함수
    function toggleView() {
        isTeacherView = !isTeacherView; // 상태 전환

        if (isTeacherView) {
            seatingChartArea.appendChild(teacherDesk); // 교탁을 맨 아래로 이동
            teacherDesk.classList.remove('mb-8');
            teacherDesk.classList.add('mt-8');
            toggleViewBtn.textContent = '🧑‍🎓 학생 시점';
        } else {
            seatingChartArea.prepend(teacherDesk); // 교탁을 맨 위로 이동
            teacherDesk.classList.add('mb-8');
            teacherDesk.classList.remove('mt-8');
            toggleViewBtn.textContent = '👩‍🏫 교사 시점';
        }
        // 변경된 시점으로 자리 배치도를 다시 그림
        renderSeatingChart(seatingChartContainer, seatAssignments);
    }
    
    // [추가] 책상 DOM 요소를 생성하는 헬퍼 함수
    function createDeskOrPlaceholder(deskCell, assignments, container) {
        if (deskCell && deskCell.isDesk) {
            const assignment = assignments.find(a => a.deskId === deskCell.id);
            const student = assignment ? students.find(s => s.id == assignment.studentId) : null;
            const deskDiv = document.createElement('div');
            deskDiv.className = 'desk w-28 h-20 border-2 rounded-md flex flex-col items-center justify-center p-1';
            deskDiv.dataset.deskId = deskCell.id;

            if (student) {
                deskDiv.innerHTML = `<span class="font-bold text-lg">${student.name}</span><span class="text-xs text-gray-600">(${student.id})</span>`;
                deskDiv.classList.add('bg-blue-100', 'border-blue-300');
            } else {
                deskDiv.innerHTML = `<span class="text-gray-400">빈자리</span>`;
                deskDiv.classList.add('bg-gray-100', 'border-gray-300');
            }
            if (assignment && assignment.locked) deskDiv.classList.add('locked');
            
            // 컨테이너 종류에 따라 다른 이벤트 핸들러를 연결
            const clickHandler = (container === seatingChartContainer) ? handleDeskClick : handlePresetDeskClick;
            deskDiv.addEventListener('click', clickHandler);
            return deskDiv;
        } else {
            const placeholderDiv = document.createElement('div');
            placeholderDiv.className = 'w-28 h-20';
            return placeholderDiv;
        }
    }
    
    // [수정] renderSeatingChart 함수를 교사 시점 모드를 고려하도록 수정
    function renderSeatingChart(container, assignments) {
        container.innerHTML = '';
        const groups = [document.createElement('div'), document.createElement('div'), document.createElement('div')];
        groups.forEach(g => {
            g.className = 'grid grid-cols-2 gap-3';
            container.appendChild(g);
        });
        
        // 6x6 그리드를 순회
        for (let row = 0; row < 6; row++) {
            for (let col = 0; col < 6; col++) {
                const cellId = row * 6 + col;
                const deskCell = layout.find(c => c.id === cellId);
                
                // 어느 그룹에 책상을 넣을지 결정
                let groupIndex;
                if (isTeacherView && container === seatingChartContainer) {
                    // 교사 시점일 때: 열 순서를 반대로 (4,5 -> 0 / 2,3 -> 1 / 0,1 -> 2)
                    groupIndex = col < 2 ? 2 : (col < 4 ? 1 : 0);
                } else {
                    // 학생 시점일 때: 원래 순서대로 (0,1 -> 0 / 2,3 -> 1 / 4,5 -> 2)
                    groupIndex = col < 2 ? 0 : (col < 4 ? 1 : 2);
                }
                
                const deskElement = createDeskOrPlaceholder(deskCell, assignments, container);

                // 책상을 그룹에 추가
                if (isTeacherView && container === seatingChartContainer) {
                     // 교사 시점일 때: prepend로 추가하여 행 순서를 반대로 (상하 반전)
                    groups[groupIndex].prepend(deskElement);
                } else {
                    // 학생 시점일 때: append로 순서대로 추가
                    groups[groupIndex].appendChild(deskElement);
                }
            }
        }
    }


    function handleDeskClick(e) {
        const clickedDeskId = parseInt(e.currentTarget.dataset.deskId, 10);
        const assignmentIndex = seatAssignments.findIndex(a => a.deskId === clickedDeskId);
        if (e.shiftKey) {
            seatAssignments[assignmentIndex].locked = !seatAssignments[assignmentIndex].locked;
            e.currentTarget.classList.toggle('locked');
            saveAssignments();
            return;
        }
        if (selectedDesk === null) {
            selectedDesk = e.currentTarget;
            selectedDesk.classList.add('selected');
        } else {
            if (selectedDesk !== e.currentTarget) {
                const firstDeskId = parseInt(selectedDesk.dataset.deskId, 10);
                const firstIndex = seatAssignments.findIndex(a => a.deskId === firstDeskId);
                [seatAssignments[firstIndex].studentId, seatAssignments[assignmentIndex].studentId] = [seatAssignments[assignmentIndex].studentId, seatAssignments[firstIndex].studentId];
                renderSeatingChart(seatingChartContainer, seatAssignments);
                saveAssignments();
            }
            selectedDesk.classList.remove('selected');
            selectedDesk = null;
        }
    }

    function handleRandomizeClick(event) {
        if (event.ctrlKey) {
            applyTeacherPreset();
        } else {
            runRandomShuffle();
        }
    }

    function startCountdownAnimation(onComplete) {
        let count = 3;
        countdownOverlay.classList.remove('hidden');
        countdownOverlay.classList.add('flex');
        countdownText.textContent = count;
        const timer = setInterval(() => {
            count--;
            if (count > 0) {
                countdownText.textContent = count;
            } else {
                clearInterval(timer);
                countdownOverlay.classList.add('hidden');
                countdownOverlay.classList.remove('flex');
                if (onComplete) {
                    onComplete();
                }
            }
        }, 1000);
    }

    function runRandomShuffle() {
        const unlockedAssignments = seatAssignments.filter(a => !a.locked && a.studentId);
        const unlockedStudentIds = unlockedAssignments.map(a => a.studentId);
        if (unlockedStudentIds.length < 2) {
            // alert 대신 커스텀 모달이나 메시지 박스를 사용하는 것이 좋지만, 기존 로직을 유지합니다.
            alert('고정되지 않고 학생이 배정된 자리가 2개 이상이어야 합니다.');
            return;
        }
        for (let i = unlockedStudentIds.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [unlockedStudentIds[i], unlockedStudentIds[j]] = [unlockedStudentIds[j], unlockedStudentIds[i]];
        }
        let studentIndex = 0;
        seatAssignments.forEach(assignment => {
            if (!assignment.locked && assignment.studentId) {
                assignment.studentId = unlockedStudentIds[studentIndex++] || null;
            }
        });
        
        startCountdownAnimation(() => {
            renderSeatingChart(seatingChartContainer, seatAssignments);
            saveAssignments();
        });
    }
    
    function saveAssignments() {
        localStorage.setItem('seatAssignments', JSON.stringify(seatAssignments));
    }
    
    // [수정] saveAsImage 함수에서 시점 강제 전환 로직 제거
    function saveAsImage() {
        // DOM이 업데이트될 시간을 약간 줌
        setTimeout(() => {
            html2canvas(document.getElementById('seating-chart-area'), { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'seating-chart.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }, 100);
    }

    function openTeacherPresetModal() {
        const deskCells = layout.filter(c => c.isDesk);
        const savedPreset = JSON.parse(localStorage.getItem('teacherPresetAssignments')) || [];
        teacherPresetAssignments = deskCells.map(desk => {
            const preset = savedPreset.find(p => p.deskId === desk.id);
            return { deskId: desk.id, studentId: preset ? preset.studentId : null };
        });
        if (savedPreset.length === 0) {
            teacherPresetAssignments = seatAssignments.map(a => ({ deskId: a.deskId, studentId: a.studentId }));
        }
        renderSeatingChart(teacherPresetEditorContainer, teacherPresetAssignments);
        teacherPresetModal.classList.remove('hidden');
        teacherPresetModal.classList.add('flex');
    }

    function closeTeacherPresetModal() {
        teacherPresetModal.classList.add('hidden');
        teacherPresetModal.classList.remove('flex');
        selectedPresetDesk = null;
    }

    function saveTeacherPreset() {
        localStorage.setItem('teacherPresetAssignments', JSON.stringify(teacherPresetAssignments));
        closeTeacherPresetModal();
    }

    function handlePresetDeskClick(e) {
        const clickedDesk = e.currentTarget;
        if (selectedPresetDesk === null) {
            selectedPresetDesk = clickedDesk;
            selectedPresetDesk.classList.add('selected');
        } else {
            if (selectedPresetDesk !== clickedDesk) {
                const firstDeskId = parseInt(selectedPresetDesk.dataset.deskId, 10);
                const secondDeskId = parseInt(clickedDesk.dataset.deskId, 10);
                const firstIndex = teacherPresetAssignments.findIndex(a => a.deskId === firstDeskId);
                const secondIndex = teacherPresetAssignments.findIndex(a => a.deskId === secondDeskId);
                [teacherPresetAssignments[firstIndex].studentId, teacherPresetAssignments[secondIndex].studentId] = 
                [teacherPresetAssignments[secondIndex].studentId, teacherPresetAssignments[firstIndex].studentId];
                renderSeatingChart(teacherPresetEditorContainer, teacherPresetAssignments);
            }
            selectedPresetDesk.classList.remove('selected');
            selectedPresetDesk = null;
        }
    }

    function applyTeacherPreset() {
        if (seatAssignments.some(a => a.locked)) {
            return;
        }
        const preset = JSON.parse(localStorage.getItem('teacherPresetAssignments'));
        if (!preset || preset.length === 0) {
            return;
        }
        seatAssignments = seatAssignments.map(currentAssignment => {
            const presetAssignment = preset.find(p => p.deskId === currentAssignment.deskId);
            return {
                ...currentAssignment,
                studentId: presetAssignment ? presetAssignment.studentId : null
            };
        });
        
        startCountdownAnimation(() => {
            renderSeatingChart(seatingChartContainer, seatAssignments);
            saveAssignments();
        });
    }

    function init() {
        loadSettings();
        renderLayoutEditor();
        initializeMainPage();
        navs.main.addEventListener('click', () => switchPage('main'));
        navs.settings.addEventListener('click', () => switchPage('settings'));
        saveSettingsBtn.addEventListener('click', saveSettings);
        randomizeBtn.addEventListener('click', handleRandomizeClick);
        saveImageBtn.addEventListener('click', saveAsImage);
        teacherPresetBtn.addEventListener('click', openTeacherPresetModal);
        closePresetModalBtn.addEventListener('click', closeTeacherPresetModal);
        savePresetBtn.addEventListener('click', saveTeacherPreset);
        // [추가] 교사 시점 전환 버튼에 이벤트 리스너 추가
        toggleViewBtn.addEventListener('click', toggleView);
    }

    init();
});
</script>
</body>
</html>
